name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Set to 'true' to enable the (optional) smoke backtest job
  RUN_SMOKE: 'false'

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10, 3.11, 3.12]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint (ruff)
        run: |
          python -m pip install --upgrade pip
          pip install ruff
          ruff check .

      - name: Run tests
        run: |
          pip install pytest
          pytest -q

  smoke-backtest:
    name: Optional Smoke Backtest
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: env.RUN_SMOKE == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run smoke backtest (if sample data exists)
        run: |
          if [ -f data/processed/BTCUSDT-15m-2023.parquet ]; then
            python3 scripts/run_backtest.py --strategy ema_crossover --data data/processed/BTCUSDT-15m-2023.parquet --market BTCUSDT --start-date 2023-01-01 --end-date 2023-03-31
          else
            echo "No sample data found; skipping smoke backtest. To enable, add sample data or set RUN_SMOKE=true in workflow_dispatch.";
          fi
