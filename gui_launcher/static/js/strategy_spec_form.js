(function(){
  function removeRow(btn) { const row = btn.closest('.card'); if (row) row.remove(); }
  function rowSide(row) { if (!row) return 'long'; if (row.querySelector('input[name="short_tf"]')) return 'short'; return 'long'; }
  function q(row, sel) { return row ? row.querySelector(sel) : null; }
  function val(row, sel) { const el = q(row, sel); return el ? String(el.value || '').trim() : ''; }
  function showFields(row, cls) { for (const el of row.querySelectorAll('.cond-fields')) el.style.display = 'none'; const target = row.querySelector(cls); if (target) target.style.display = 'block'; }
  function buildExpr(row) { const side = rowSide(row); const typ = (val(row, `select[name="${side}_type"]`) || 'custom').toLowerCase(); if (typ === 'custom') return val(row, '.cond-expr-custom'); if (typ === 'ma_cross') { const ma = (val(row, `select[name="${side}_cross_ma"]`) || 'ema').toLowerCase(); const fast = val(row, `input[name="${side}_cross_fast"]`); const slow = val(row, `input[name="${side}_cross_slow"]`); const dir = (val(row, `select[name="${side}_cross_direction"]`) || 'above').toLowerCase(); if (!fast || !slow) return ''; const fn = (dir === 'below') ? 'crosses_below' : 'crosses_above'; return `${fn}(${ma}(close, ${fast}), ${ma}(close, ${slow}))`; } if (typ === 'rsi') { const len = val(row, `input[name="${side}_rsi_len"]`) || '14'; const op = val(row, `select[name="${side}_rsi_op"]`) || '<'; const level = val(row, `input[name="${side}_rsi_level"]`); if (!level) return ''; return `rsi(close, ${len}) ${op} ${level}`; } if (typ === 'close_vs_ma') { const ma = (val(row, `select[name="${side}_cv_ma"]`) || 'ema').toLowerCase(); const op = val(row, `select[name="${side}_cv_op"]`) || '>'; const len = val(row, `input[name="${side}_cv_len"]`); if (!len) return ''; return `close ${op} ${ma}(close, ${len})`; } if (typ === 'donchian') { const len = val(row, `input[name="${side}_don_len"]`); const dir = (val(row, `select[name="${side}_don_direction"]`) || 'breakout').toLowerCase(); if (!len) return ''; if (dir === 'breakdown') return `crosses_below(close, shift(donchian_low(${len}), 1))`; return `crosses_above(close, shift(donchian_high(${len}), 1))`; } return ''; }
  function syncExpr(row) { const expr = buildExpr(row); const hidden = q(row, '.cond-expr'); if (hidden) hidden.value = expr; const preview = q(row, '.cond-expr-preview'); if (preview) preview.textContent = expr || '(incomplete)'; }
  function updateRowUI(row) { const side = rowSide(row); const typ = (val(row, `select[name="${side}_type"]`) || 'custom').toLowerCase(); if (typ === 'ma_cross') showFields(row, '.cond-ma-cross'); else if (typ === 'rsi') showFields(row, '.cond-rsi'); else if (typ === 'close_vs_ma') showFields(row, '.cond-close-vs-ma'); else if (typ === 'donchian') showFields(row, '.cond-donchian'); else showFields(row, '.cond-custom'); syncExpr(row); }
  function onCondTypeChange(sel) { const row = sel.closest('.cond-row'); if (row) updateRowUI(row); }
  function initCondRow(row) { if (!row) return; row.addEventListener('input', () => updateRowUI(row)); row.addEventListener('change', () => updateRowUI(row)); updateRowUI(row); }
  function addCond(side) { const container = document.getElementById(side + 'Conds'); const entryTf = (document.getElementById('entry_tf') || {}).value || '1h'; const card = document.createElement('div'); card.className = 'card cond-row'; card.style.padding = '10px'; card.innerHTML = `...`; container.appendChild(card); initCondRow(card); }
  for (const row of document.querySelectorAll('.cond-row')) initCondRow(row);
  function toggleStopFields() { const t = document.getElementById('stop_type').value; const pct = document.getElementById('stop_percent_wrap'); const atr = document.getElementById('stop_atr_wrap'); if (t === 'percent') { pct.style.display = 'block'; atr.style.display = 'none'; } else { pct.style.display = 'none'; atr.style.display = 'grid'; } }
  toggleStopFields();
  function refreshAdvanced() { const r = document.getElementById('adv_risk_enabled'); const rf = document.getElementById('adv_risk_fields'); if (rf) rf.style.display = (r && r.checked) ? 'block' : 'none'; const c = document.getElementById('adv_calendar_enabled'); const cf = document.getElementById('adv_calendar_fields'); if (cf) cf.style.display = (c && c.checked) ? 'block' : 'none'; const tm = document.getElementById('adv_tm_enabled'); const tmf = document.getElementById('adv_tm_fields'); if (tmf) tmf.style.display = (tm && tm.checked) ? 'block' : 'none'; const ex = document.getElementById('adv_exec_enabled'); const exf = document.getElementById('adv_exec_fields'); if (exf) exf.style.display = (ex && ex.checked) ? 'block' : 'none'; }
  function refreshCalendarCustom() { const cal = document.querySelector('input[name="calendar_mode"]:checked'); const cc = document.getElementById('calendar_custom'); if (cc) cc.style.display = (cal && cal.value === 'custom') ? 'block' : 'none'; }
  function refreshTmSubfields() { const tp = document.querySelector('input[name="tp_mode"]:checked'); const tpCustom = document.getElementById('tp_custom'); if (tpCustom) tpCustom.style.display = (tp && tp.value === 'custom') ? 'block' : 'none'; const pe = document.getElementsByName('partial_enabled')[0]; const partialFields = document.getElementById('partial_fields'); if (partialFields) partialFields.style.display = (pe && pe.checked) ? 'block' : 'none'; const ts = document.getElementsByName('trailing_enabled')[0]; const trailingFields = document.getElementById('trailing_fields'); if (trailingFields) trailingFields.style.display = (ts && ts.checked) ? 'block' : 'none'; }
  document.addEventListener('change', () => { refreshAdvanced(); refreshCalendarCustom(); refreshTmSubfields(); });
  refreshAdvanced(); refreshCalendarCustom(); refreshTmSubfields();
  function parseCsvInts(s) { if (!s) return []; return String(s).split(',').map(x => parseInt(x.trim(), 10)).filter(x => Number.isFinite(x)); }
  function copyMasterCalendar() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const custom = document.querySelector('input[name="calendar_mode"][value="custom"]'); if (custom) custom.checked = true; const allowed = new Set(parseCsvInts(md.dataset.allowedDays)); document.querySelectorAll('input[name="dow"]').forEach(cb => { const v = parseInt(cb.value, 10); cb.checked = allowed.has(v); }); const sa = document.getElementsByName('session_Asia')[0]; const sl = document.getElementsByName('session_London')[0]; const sn = document.getElementsByName('session_NewYork')[0]; if (sa) sa.checked = md.dataset.sessionAsiaEnabled === '1'; if (sl) sl.checked = md.dataset.sessionLondonEnabled === '1'; if (sn) sn.checked = md.dataset.sessionNewyorkEnabled === '1'; const asa = document.getElementsByName('session_Asia_start')[0]; const aea = document.getElementsByName('session_Asia_end')[0]; const asl = document.getElementsByName('session_London_start')[0]; const ael = document.getElementsByName('session_London_end')[0]; const asn = document.getElementsByName('session_NewYork_start')[0]; const aen = document.getElementsByName('session_NewYork_end')[0]; if (asa) asa.value = md.dataset.sessionAsiaStart || asa.value; if (aea) aea.value = md.dataset.sessionAsiaEnd || aea.value; if (asl) asl.value = md.dataset.sessionLondonStart || asl.value; if (ael) ael.value = md.dataset.sessionLondonEnd || ael.value; if (asn) asn.value = md.dataset.sessionNewyorkStart || asn.value; if (aen) aen.value = md.dataset.sessionNewyorkEnd || aen.value; refresh(); }
  function copyMasterTp() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const custom = document.querySelector('input[name="tp_mode"][value="custom"]'); if (custom) custom.checked = true; const tr = document.getElementsByName('tp1_target_r')[0]; const ep = document.getElementsByName('tp1_exit_pct')[0]; const en = document.getElementsByName('tp1_enabled')[0]; if (en) en.checked = true; if (tr) tr.value = md.dataset.tpTargetR || tr.value; if (ep) ep.value = md.dataset.tpExitPct || ep.value; refresh(); }
  function copyMasterPartial() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const en = document.getElementsByName('partial_enabled')[0]; if (en) en.checked = md.dataset.partialEnabled === '1'; const l1en = document.getElementsByName('partial1_enabled')[0]; const lr = document.getElementsByName('partial1_level_r')[0]; const ep = document.getElementsByName('partial1_exit_pct')[0]; if (l1en) l1en.checked = true; if (lr) lr.value = md.dataset.partialLevelR || lr.value; if (ep) ep.value = md.dataset.partialExitPct || ep.value; refresh(); }
  function copyMasterTrailing() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const en = document.getElementsByName('trailing_enabled')[0]; if (en) en.checked = md.dataset.trailingEnabled === '1'; const len = document.getElementsByName('trailing_length')[0]; const ar = document.getElementsByName('trailing_activation_r')[0]; const st = document.getElementsByName('trailing_stepped')[0]; const mm = document.getElementsByName('trailing_min_move_pips')[0]; if (len) len.value = md.dataset.trailingLength || len.value; if (ar) ar.value = md.dataset.trailingActivationR || ar.value; if (st) st.checked = md.dataset.trailingStepped === '1'; if (mm) mm.value = md.dataset.trailingMinMovePips || mm.value; refresh(); }
  const calBtn = document.getElementById('copyMasterCalendarBtn'); if (calBtn) calBtn.addEventListener('click', copyMasterCalendar); const tpBtn = document.getElementById('copyMasterTpBtn'); if (tpBtn) tpBtn.addEventListener('click', copyMasterTp); const peBtn = document.getElementById('copyMasterPartialBtn'); if (peBtn) peBtn.addEventListener('click', copyMasterPartial); const tsBtn = document.getElementById('copyMasterTrailingBtn'); if (tsBtn) tsBtn.addEventListener('click', copyMasterTrailing);
  document.addEventListener('change', () => { refreshAdvanced(); refreshCalendarCustom(); refreshTmSubfields(); });
})();