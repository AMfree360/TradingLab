(function(){
  const stopTypeEl = document.getElementById('stop_type');
  const stopAtrEl = document.getElementById('stop_atr');
  const stopPctEl = document.getElementById('stop_percent');
  const calCustom = document.getElementById('calendar_custom');
  const tpCustom = document.getElementById('tp_custom');
  const partialFields = document.getElementById('partial_fields');
  const trailingFields = document.getElementById('trailing_fields');

  function refreshStops() { const v = stopTypeEl ? stopTypeEl.value : 'atr'; if (stopAtrEl) stopAtrEl.style.display = (v === 'atr') ? 'block' : 'none'; if (stopPctEl) stopPctEl.style.display = (v === 'percent') ? 'block' : 'none'; }
  function refreshRadios() { const cal = document.querySelector('input[name="calendar_mode"]:checked'); if (calCustom) calCustom.style.display = (cal && cal.value === 'custom') ? 'block' : 'none'; const tp = document.querySelector('input[name="tp_mode"]:checked'); if (tpCustom) tpCustom.style.display = (tp && tp.value === 'custom') ? 'block' : 'none'; }
  function refreshCheckboxes() { const pe = document.getElementsByName('partial_enabled')[0]; if (partialFields) partialFields.style.display = (pe && pe.checked) ? 'block' : 'none'; const ts = document.getElementsByName('trailing_enabled')[0]; if (trailingFields) trailingFields.style.display = (ts && ts.checked) ? 'block' : 'none'; }

  document.addEventListener('change', () => { refreshStops(); refreshRadios(); refreshCheckboxes(); });
  refreshStops(); refreshRadios(); refreshCheckboxes();

  function parseCsvInts(s) { if (!s) return []; return String(s).split(',').map(x => parseInt(x.trim(), 10)).filter(x => Number.isFinite(x)); }
  function copyMasterCalendar() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const custom = document.querySelector('input[name="calendar_mode"][value="custom"]'); if (custom) custom.checked = true; const allowed = new Set(parseCsvInts(md.dataset.allowedDays)); document.querySelectorAll('input[name="dow"]').forEach(cb => { const v = parseInt(cb.value, 10); cb.checked = allowed.has(v); }); const sa = document.getElementsByName('session_Asia')[0]; const sl = document.getElementsByName('session_London')[0]; const sn = document.getElementsByName('session_NewYork')[0]; if (sa) sa.checked = md.dataset.sessionAsiaEnabled === '1'; if (sl) sl.checked = md.dataset.sessionLondonEnabled === '1'; if (sn) sn.checked = md.dataset.sessionNewyorkEnabled === '1'; refreshRadios(); }
  function copyMasterTp() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const custom = document.querySelector('input[name="tp_mode"][value="custom"]'); if (custom) custom.checked = true; const tr = document.getElementsByName('tp_target_r')[0]; const ep = document.getElementsByName('tp_exit_pct')[0]; if (tr) tr.value = md.dataset.tpTargetR || tr.value; if (ep) ep.value = md.dataset.tpExitPct || ep.value; refreshRadios(); }
  function copyMasterPartial() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const en = document.getElementsByName('partial_enabled')[0]; if (en) en.checked = md.dataset.partialEnabled === '1'; const lr = document.getElementsByName('partial_level_r')[0]; const ep = document.getElementsByName('partial_exit_pct')[0]; if (lr) lr.value = md.dataset.partialLevelR || lr.value; if (ep) ep.value = md.dataset.partialExitPct || ep.value; refreshCheckboxes(); }
  function copyMasterTrailing() { const md = document.getElementById('masterDefaults'); if (!md || !md.dataset) return; const en = document.getElementsByName('trailing_enabled')[0]; if (en) en.checked = md.dataset.trailingEnabled === '1'; const len = document.getElementsByName('trailing_length')[0]; const ar = document.getElementsByName('trailing_activation_r')[0]; const st = document.getElementsByName('trailing_stepped')[0]; const mm = document.getElementsByName('trailing_min_move_pips')[0]; if (len) len.value = md.dataset.trailingLength || len.value; if (ar) ar.value = md.dataset.trailingActivationR || ar.value; if (st) st.checked = md.dataset.trailingStepped === '1'; if (mm) mm.value = md.dataset.trailingMinMovePips || mm.value; refreshCheckboxes(); }
  const calBtn = document.getElementById('copyMasterCalendarBtn'); if (calBtn) calBtn.addEventListener('click', copyMasterCalendar); const tpBtn = document.getElementById('copyMasterTpBtn'); if (tpBtn) tpBtn.addEventListener('click', copyMasterTp); const peBtn = document.getElementById('copyMasterPartialBtn'); if (peBtn) peBtn.addEventListener('click', copyMasterPartial); const tsBtn = document.getElementById('copyMasterTrailingBtn'); if (tsBtn) tsBtn.addEventListener('click', copyMasterTrailing);